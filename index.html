<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Points - The Icon Public School</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        .main-header { background: #ffcc00; padding: 10px 15px; text-align: center; }
        .main-title { margin: 0; color: #000; font-size: 1.8em; font-weight: bold; }
        #app { padding: 20px; min-height: 80vh; text-align: center; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 500px;  /* smaller width */
            height: 500px;     /* smaller height */
            margin: 30px auto; 
        }
        .house-links { 
            margin: 30px auto; 
            max-width: 900px; 
            display: flex; 
            justify-content: center; 
            gap: 60px; 
            flex-wrap: wrap; 
        }
        .house-link img { 
            width: 140px; 
            height: 140px; 
            object-fit: contain; 
            cursor: pointer; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transition: transform 0.3s, box-shadow 0.3s; 
        }
        .house-link img:hover { 
            transform: scale(1.08); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
        }
        .admin-section { 
            margin: 60px auto; 
            max-width: 500px; 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }
        .admin-section h3 { margin-bottom: 30px; color: #333; font-size: 1.8em; }
        .admin-section input { width: 100%; padding: 16px; font-size: 1.3em; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 20px; }
        .admin-section button { background: #006400; color: white; padding: 16px 40px; border: none; border-radius: 8px; font-size: 1.5em; cursor: pointer; width: 100%; }
        .admin-section button:hover { background: #004d00; }
        #adminMessage { margin-top: 20px; font-weight: bold; font-size: 1.2em; }
        .form-container { background: white; padding: 50px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 700px; margin: 40px auto; }
        .commit-form label { display: block; margin: 25px 0 10px; font-weight: bold; text-align: left; font-size: 1.1em; }
        .commit-form select, .commit-form input { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.1em; box-sizing: border-box; }
        .commit-form button { background: #006400; color: white; padding: 18px 40px; border: none; border-radius: 8px; font-size: 1.3em; cursor: pointer; margin-top: 30px; }
        .commit-form button:hover { background: #004d00; }
        #message { margin-top: 25px; font-weight: bold; font-size: 1.2em; }
        .back-link { display: block; margin: 50px auto 20px; text-align: center; color: #006400; font-weight: bold; font-size: 1.3em; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<header class="main-header">
    <h1 class="main-title">THE ICON PUBLIC SCHOOL</h1>
</header>

<div id="app"></div>

<script>
const API = "https://backend-6fz3.onrender.com/api";
const PASSWORDS = {
    "icon2026": "Admin",
    "icon2025": "Rebecca maam",
    "icon2024": "Sarita maam"
};

let authorizedBy = null;

const houses = ["titan", "phoenix", "unicorn", "trojan"];
const houseNames = { titan: "Titan", phoenix: "Phoenix", unicorn: "Unicorn", trojan: "Trojan" };
const houseLogos = { 
    titan: "titan.jpg", 
    phoenix: "phoenix.jpg", 
    unicorn: "unicorn.jpg", 
    trojan: "trojan.jpg" 
};

const headerColors = { titan: "#006400", phoenix: "#004080", unicorn: "#b8860b", trojan: "#8B0000" };
const bgAlternates = { titan: "#f0fff0", phoenix: "#f0f8ff", unicorn: "#fffbe6", trojan: "#fff0f0" };
const hoverBgs = { titan: "#e0ffe0", phoenix: "#e0f0ff", unicorn: "#fff5cc", trojan: "#ffe0e0" };

let chart;

function navigate() {
    const hash = window.location.hash.substring(1).toLowerCase().replace(/\/$/, '');
    const path = hash || '/';

    const houseMatch = path.match(/^([a-z]+)$/);
    if (houseMatch && houses.includes(houseMatch[1])) {
        showHousePage(houseMatch[1]);
        return;
    }

    showChart();
}

async function showChart() {
    document.getElementById("app").innerHTML = `
        <div class="house-links">
            <div class="house-link"><img src=" ${houseLogos.titan}" alt="Titan" onclick="window.location.hash='titan'"></div>
            <div class="house-link"><img src=" ${houseLogos.phoenix}" alt="Phoenix" onclick="window.location.hash='phoenix'"></div>
            <div class="house-link"><img src=" ${houseLogos.unicorn}" alt="Unicorn" onclick="window.location.hash='unicorn'"></div>
            <div class="house-link"><img src=" ${houseLogos.trojan}" alt="Trojan" onclick="window.location.hash='trojan'"></div>
        </div>
        <div class="chart-container">
            <canvas id="houseChart"></canvas>
        </div>
        <div style="max-width:1000px;margin:40px auto;">
          <h2 style="margin-bottom:20px;">Latest Activity</h2>
            <div id="latestCommits" style="
             display:grid;
             grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
             gap:20px;">
              <div>Loading latest commits...</div>
            </div>
        </div>
        <div class="admin-section">
            <h3>Admin Access</h3>
            <input type="password" id="adminPassword" placeholder="Enter password">
            <button id="adminEnter">Enter Admin Mode</button>
            <div id="adminMessage"></div>
        </div>
    `;

    let points = [0, 0, 0, 0];

    try {
      const res = await fetch(`${API}/housepoints`);
      if (res.ok) {
        const result = await res.json();
        const data = result.data || [];

        points = houses.map(houseName => {
            const houseObj = data.find(x => x.name?.toLowerCase() === houseName);
            return houseObj ? houseObj.points : 0;
        });
      }
    } catch (err) {
      console.log("Error loading chart data", err);
    }

    // REAL data (can be negative)
    const realData = points;

// SAFE data for pie chart rendering (must be positive)
    const safeData = realData.map(p => p <= 0 ? 1 : p);

    chart = new Chart(document.getElementById("houseChart"), {
        type: "pie",
        data: {
            labels: ["Titan", "Phoenix", "Unicorn", "Trojan"],
            datasets: [{
              data: safeData,
              backgroundColor: ["#00b140", "#007bff", "#ffea00", "#d60000"]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                position: "bottom", 
                labels: { font: { size: 16 } } 
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                  const index = context.dataIndex;
                  const realValue = realData[index];
                  return context.label + ": " + realValue;
                  }
                }
              }
            },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const i = elements[0].index;
                    window.location.hash = houses[i];
                }
            }
        }
    });

    const adminBtn = document.getElementById("adminEnter");
    const adminInput = document.getElementById("adminPassword");
    const adminMsg = document.getElementById("adminMessage");

    adminBtn.addEventListener("click", () => {
        const password = adminInput.value.trim();
        if (PASSWORDS[password]) {
          authorizedBy = PASSWORDS[password];
          showCommitPage();
        } else {
          adminMsg.textContent = "Wrong password";
          adminMsg.style.color = "red";
        }
    });

    adminInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") adminBtn.click();
    });

    loadLatestCommits();
}

async function loadLatestCommits() {
    const container = document.getElementById("latestCommits");
    container.innerHTML = "";

    for (const house of houses) {
        try {
            const res = await fetch(`${API}/${house}_commit`);
            const json = await res.json();
            const commits = json.success && json.data ? json.data : [];

            const latest = commits[0]; // assuming newest first

            const card = document.createElement("div");
            card.style.background = "white";
            card.style.padding = "20px";
            card.style.borderRadius = "12px";
            card.style.boxShadow = "0 4px 15px rgba(0,0,0,0.1)";
            card.style.cursor = "pointer";

            card.onclick = () => window.location.hash = house;

            if (latest) {
                card.innerHTML = `
                    <h3 style="margin:0 0 10px;color:${headerColors[house]}">
                        ${houseNames[house]}
                    </h3>
                    <p style="margin:5px 0;"><b>${escapeHtml(latest.name)}</b></p>
                    <p style="margin:5px 0;">${escapeHtml(latest.reason)}</p>
                    <p style="margin:5px 0;font-weight:bold;">
                        ${latest.points > 0 ? '+' : ''}${latest.points}
                    </p>
                    <p style="margin:5px 0;color:#777;font-size:0.9em;">
                        ${new Date(latest.createdAt).toLocaleDateString()}
                    </p>
                `;
            } else {
                card.innerHTML = `
                    <h3 style="color:${headerColors[house]}">${houseNames[house]}</h3>
                    <p>No commits yet</p>
                `;
            }

            container.appendChild(card);

        } catch (err) {
            console.log("Error loading latest for", house);
        }
    }
}

async function showHousePage(house) {
    const headerColor = headerColors[house];
    const altBg = bgAlternates[house];
    const hoverBg = hoverBgs[house];

    document.getElementById("app").innerHTML = `
        <div style="max-width:900px;margin:0 auto;padding:20px;">
            <img src=" ${houseLogos[house]}" style="width:200px;height:200px;margin:30px auto;display:block;" onerror="this.style.display='none'">
            <div id="points" style="font-size:3em;font-weight:bold;color:${headerColor};margin:40px 0;">Loading points...</div>
            <table style="width:90%;max-width:800px;margin:40px auto;background:white;
                   box-shadow:0 4px 20px rgba(0,0,0,0.15);border-radius:12px;border-collapse:separate;border-spacing:0;">
                <thead>
                    <tr>
                        <th style="background:${headerColor};color:white;padding:18px;border-top-left-radius:12px;font-size:1.2em;">Student Name</th>
                        <th style="background:${headerColor};color:white;padding:18px;font-size:1.2em;">Anecdote</th>
                        <th style="background:${headerColor};color:white;padding:18px;font-size:1.2em;">Points</th>
                        <th style="background:${headerColor};color:white;padding:18px;font-size:1.2em;">Given By</th>
                        <th style="background:${headerColor};color:white;padding:18px;font-size:1.2em;">Authorized By</th>
                        <th style="background:${headerColor};color:white;padding:18px;border-top-right-radius:12px;font-size:1.2em;">Date</th>
                    </tr>
                </thead>
                <tbody id="commitBody"><tr><td colspan="6">Loading commits...</td></tr></tbody>
            </table>
            <a href="/" class="back-link">← Back to Chart</a>
        </div>
    `;

    try {
      const res = await fetch(`${API}/housepoints`);
      const result = await res.json();
      const data = result.data || [];
      const h = data.find(x => x.name?.toLowerCase() === house);
      document.getElementById("points").textContent =
        `Total Points: ${h?.points ?? 0}`;
    } catch (err) {
      document.getElementById("points").textContent =
        "Total Points: (offline)";
    }

    try {
        const res = await fetch(`${API}/${house}_commit`);
        const json = await res.json();
        const commits = json.success && json.data ? json.data : [];
        const tbody = document.getElementById("commitBody");
        tbody.innerHTML = commits.length === 0 ? `<tr><td colspan="6">No commits yet</td></tr>` : "";
        commits.forEach((c, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td style="font-weight:bold;color:${headerColor};padding:15px;">
               ${escapeHtml(c.name || "Unknown")}
              </td>
              <td style="padding:15px;">
               ${escapeHtml(c.reason || "No anecdote")}
              </td>
              <td style="padding:15px;">
               ${c.points ?? 0}
              </td>
              <td style="padding:15px;font-weight:bold;color:#444;">
               ${escapeHtml(c.teacher || "Unknown")}
              </td>
              <td style="padding:15px;font-weight:bold;color:#666;">
                ${escapeHtml(c.authorizedBy || "Unknown")}
              </td>
              <td style="padding:15px;">
               ${new Date(c.createdAt).toLocaleDateString()}
              </td>
            `;
            tr.style.backgroundColor = i % 2 === 0 ? altBg : "white";
            tr.onmouseover = () => tr.style.backgroundColor = hoverBg;
            tr.onmouseout = () => tr.style.backgroundColor = i % 2 === 0 ? altBg : "white";
            tbody.appendChild(tr);
        });
        if (tbody.lastElementChild) {
            const last = tbody.lastElementChild;
            last.style.borderBottomLeftRadius = "12px";
            last.style.borderBottomRightRadius = "12px";
            last.cells[0].style.borderBottomLeftRadius = "12px";
            last.cells[last.cells.length - 1].style.borderBottomRightRadius = "12px";
        }
    } catch (err) {
        document.getElementById("commitBody").innerHTML = `<tr><td colspan="6">Error loading commits</td></tr>`;
    }
}

function showCommitPage() {
    document.getElementById("app").innerHTML = `
        <div class="form-container">
            <h2 style="color:#333;margin-bottom:40px;font-size:2em;">Add New Commit</h2>
            <form id="commit-form" class="commit-form">
                <label for="house">House:</label>
                <select id="house">
                    <option value="titan">Titan</option>
                    <option value="phoenix">Phoenix</option>
                    <option value="unicorn">Unicorn</option>
                    <option value="trojan">Trojan</option>
                </select>
                <label for="name">Student Name:</label>
                <input type="text" id="name" required placeholder="e.g. John Doe">
                <label for="teacher">Teacher:</label>
                <input type="text" id="teacher" required placeholder="Enter teacher name">
                <label for="reasonSelect">Reason:</label>
                <select id="reasonSelect">
                  <optgroup label="Positive (+)">
                  <option value="Excellent behavior">Excellent behavior</option>
                  <option value="Helping others">Helping others</option>
                  <option value="Outstanding homework">Outstanding homework</option>
                  <option value="Leadership skills">Leadership skills</option>
                  <option value="Sports achievement">Sports achievement</option>
                  <option value="Creative work">Creative work</option>
                  <option value="Class participation">Class participation</option>
                  <option value="Discipline">Discipline</option>
                  <option value="Respectfulness">Respectfulness</option>
                  <option value="Academic excellence">Academic excellence</option>
                  </optgroup>

                  <optgroup label="Negative (-)">
                  <option value="Late submission">Late submission</option>
                  <option value="Disruptive behavior">Disruptive behavior</option>
                  <option value="Incomplete homework">Incomplete homework</option>
                  <option value="Uniform violation">Uniform violation</option>
                  <option value="Fighting">Fighting</option>
                  <option value="Disrespect">Disrespect</option>
                  <option value="Class disturbance">Class disturbance</option>
                  <option value="Late to school">Late to school</option>
                  <option value="Misconduct">Misconduct</option>
                  <option value="Rule violation">Rule violation</option>
                  </optgroup>

                  <option value="other">Other (Type manually)</option>
                </select>

                <input type="text" id="customReason" placeholder="Type custom reason..." 
                  style="display:none;margin-top:15px;">
                  <label for="points">Points (+ or -):</label>
                  <input type="number" id="points" required placeholder="e.g. 50 or -20">
                  <button type="submit">Commit</button>
              </form>
              <div id="message"></div>
            <a href="/" class="back-link">← Back to Chart</a>
        </div>
    `;

    const reasonSelect = document.getElementById("reasonSelect");
    const customReasonInput = document.getElementById("customReason");

    reasonSelect.addEventListener("change", () => {
      if (reasonSelect.value === "other") {
        customReasonInput.style.display = "block";
      } else {
        customReasonInput.style.display = "none";
        customReasonInput.value = "";
      }
    });

    document.getElementById("commit-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = document.getElementById("message");
        message.textContent = "Submitting...";
        message.style.color = "#006400";

        const houseVal = document.getElementById("house").value;
        let selectedReason = document.getElementById("reasonSelect").value;
        let customReason = document.getElementById("customReason").value.trim();

        const formData = {
          name: document.getElementById("name").value.trim(),
          reason: selectedReason === "other" ? customReason : selectedReason,
          points: Number(document.getElementById("points").value),
          teacher: document.getElementById("teacher").value.trim(),
          authorizedBy: authorizedBy
        };

        if (!formData.name || !formData.reason || isNaN(formData.points)) {
            message.textContent = "Please fill all fields correctly";
            message.style.color = "red";
            return;
        }

        try {
            const res = await fetch(`${API}/${houseVal}_commit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });

            const result = await res.json();

            if (res.ok && result.success) {
                message.textContent = `Success! ${formData.points > 0 ? '+' : ''}${formData.points} points awarded!`;
                message.style.color = "#006400";
                e.target.reset();
            } else {
                message.textContent = result.message || "Failed to submit";
                message.style.color = "red";
            }
        } catch (err) {
            message.textContent = "Network error";
            message.style.color = "red";
        }
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.addEventListener('hashchange', navigate);
navigate();
</script>
</body>
</html>